#!/bin/sh

skipping=false
until=''
problematic_package=''
if [ -n "$1" ]; then
    until="$1"
    skipping=true
fi

if [ -n "$2" ]; then
    problematic_package="$2"
fi

for d in *; do
    if [ "$skipping" = true ]; then
        if [ "$until" != "$d" ]; then
            continue
        fi
        skipping=false
    fi
    if [ "$d" = "$problematic_package" ]; then
        continue
    fi

    pushd "$d" > /dev/null
    tries=0

    while [ "10" -gt "$tries" ]; do
        rt=1
        echo ">>> $d"
        if [ -d ".git" ]; then
            git fetch --prune --all
            rt="$?"
            # if [ -n "`cat .git/config | grep '\[svn\-remote'`" ]; then
            #     git svn fetch
            # fi
            rm -rf .git/objects/pack/tmp_pack_*
        elif [ -d ".hg" ]; then
            hg pull
            rt="$?"
        fi
        test "$rt" = "0" && break
        tries=`expr $tries + 1`
    done

    popd > /dev/null
done
